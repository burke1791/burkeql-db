<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://burke1791.github.io/burkeql-db/04-data-persistence/07-parser-refactor-insert/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Parser Refactor - Insert - BurkeQL Tutorial</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Parser Refactor - Insert";
        var mkdocs_page_input_path = "04-data-persistence/07-parser-refactor-insert.md";
        var mkdocs_page_url = "/burkeql-db/04-data-persistence/07-parser-refactor-insert/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BurkeQL Tutorial
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../00-intro/project-plan/">Project Roadmap</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">1. Basic CLI</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/flex/">Flex</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/bison/">Bison</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">2. Abstract Syntax Trees</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-interface/">AST Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-implementation/">AST Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-interface/">Parser Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">3. The Database Page</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../03-db-page/page-structure/">Page Structure</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">4. Data Persistence</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../02-config-file/">Config File</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../03-loading-config/">Loading Config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../04-file-interface/">DB File Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../05-page-interface/">DB Page Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../06-page-implementation/">DB Page Implementation</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Parser Refactor - Insert</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#parsetree">Parsetree</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#lexer">Lexer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#grammar">Grammar</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#running-the-program">Running the Program</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../08-serializing-and-inserting-data/">Serializing and Inserting Data</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">5. Selecting Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/01-parser-refactor-select/">Parser Refactor - Select</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/02-the-sql-analyzer/">The SQL Analyzer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/03-buffer-pool/">Buffer Pool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/04-table-scan/">Table Scan</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/05-displaying-results/">Displaying Results</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">6. Data Types: Ints</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/01-hard-coded-table-refactor/">Hard-Coded Table Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">7. Data Types: Bool</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/01-hard-coded-table-refactor/">Hard-Coded Table Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">8. Data Types: Varchar</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/02-storage-and-fill/">Storage and Fill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/03-temporary-code-refactor/">Temporary Code Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/04-inserting-data/">Inserting Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/05-defill-and-display/">Defill and Display</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">9. Data Constraint: NULL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/03-writing-data/">Writing Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/04-reading-data/">Reading Data</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BurkeQL Tutorial</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">4. Data Persistence</li>
      <li class="breadcrumb-item active">Parser Refactor - Insert</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/burke1791/burkeql-db/edit/master/docs/04-data-persistence/07-parser-refactor-insert.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="parser-refactor-insert">Parser Refactor - Insert</h1>
<p>In order to support insert operations, we need to update our lexer/parser to identify when we want to insert data.</p>
<p>Fair warning, the next several "chapters" of this guide are going to involve writing a lot of code we're going to throw out in future sections. I'm doing it this way because it allows me to focus on a specific topic while keeping the necessary code footprint small. As we go through the next few chapters, we'll slowly build our permanent codebase, only using the temporary code as stepping stones towards a more robust database program.</p>
<p>You might be wondering how we're going to insert data into a table we haven't created yet. Simple, we're going to hard-code a basic table definition into our program - this is the first of the throwaway code we'll be writing. Our table can be defined by the following DDL:</p>
<pre><code class="language-sql">Create Table person (
    person_id Int Not Null,
    name Char(20) Not Null
);
</code></pre>
<p>So we need to update the lexer and parser to identify when we want to insert data AND what the values that we pass to it are. Our grammar isn't going to look like SQL just yet. We're going to define an insert statement as such:</p>
<pre><code class="language-shell">bql &gt; insert [person_id] [name]
</code></pre>
<p>Where <code>person_id</code> is a raw number and <code>name</code> is a QUOTED string (single quotes). So if I wanted to insert person_id: 5, name: Chris Burke, I would write:</p>
<pre><code class="language-shell">bql &gt; insert 5 'Chris Burke'
</code></pre>
<h2 id="parsetree">Parsetree</h2>
<p><code>src/include/parser/parsetree.h</code></p>
<pre><code class="language-diff"> typedef enum NodeTag {
-  T_SysCmd
+  T_SysCmd,
+  T_InsertStmt
 } NodeTag;

 typedef struct Node {
   NodeTag type;
 } Node;

 typedef struct SysCmd {
   NodeTag type;
   char* cmd;
 } SysCmd;

+typedef struct InsertStmt {
+  NodeTag type;
+  int personId;
+  char* name;
+} InsertStmt;
</code></pre>
<p>In our parsetree header we're just adding a new node type and struct to support our new insert statement. Here, you can see we're beginning to hard-code our table definition.</p>
<p><code>src/parser/parsetree.c</code></p>
<pre><code class="language-diff"> #include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
 #include &lt;stdio.h&gt;

 #include &quot;parser/parsetree.h&quot;

 static void free_syscmd(SysCmd* sc) {
   if (sc == NULL) return;

   free(sc-&gt;cmd);
 }

+static void free_insert_stmt(InsertStmt* ins) {
+  if (ins == NULL) return;
+
+  if (ins-&gt;name != NULL) free(ins-&gt;name);
+}
+
 void free_node(Node* n) {
   if (n == NULL) return;

   switch (n-&gt;type) {
     case T_SysCmd:
       free_syscmd((SysCmd*)n);
       break;
+    case T_InsertStmt:
+      free_insert_stmt((InsertStmt*)n);
+      break;
     default:
       printf(&quot;Unknown node type\n&quot;);
   }

   free(n);
 }
</code></pre>
<p>In our parsetree implementation, we need to write a function that can free the new <code>InsertStmt</code> struct. Remember, we don't need a special function to allocate memory for it because we wrote that <code>create_node</code> macro in the parsetree header.</p>
<pre><code class="language-diff"> void print_node(Node* n) {
   if (n == NULL) {
     printf(&quot;print_node() | Node is NULL\n&quot;);
     return;
   }

   printf(&quot;======  Node  ======\n&quot;);

   switch (n-&gt;type) {
     case T_SysCmd:
       printf(&quot;=  Type: SysCmd\n&quot;);
       printf(&quot;=  Cmd: %s\n&quot;, ((SysCmd*)n)-&gt;cmd);
       break;
+    case T_InsertStmt:
+      printf(&quot;=  Type: Insert\n&quot;);
+      printf(&quot;=  person_id: %d\n&quot;, ((InsertStmt*)n)-&gt;personId);
+      printf(&quot;=  name:      %s\n&quot;, ((InsertStmt*)n)-&gt;name);
+      break;
     default:
       printf(&quot;print_node() | unknown node type\n&quot;);
   }
 }
</code></pre>
<p>I'm also adding the insert node to our <code>print_node</code> logic just so we can make sure the parser processes everything correctly.</p>
<pre><code class="language-diff">+char* str_strip_quotes(char* str) {
+  int length = strlen(str);
+  char* finalStr = malloc(length - 1);
+  memcpy(finalStr, str + 1, length - 2);
+  finalStr[length - 2] = '\0';
+  free(str);
+  return finalStr;
+}
</code></pre>
<p>Lastly, we need a helper function to strip the single quote characters off of the matched input from the lexer. When we write <code>insert 5 'chris burke'</code>, our lexer will match all of <code>'chris burke'</code>, including the quote characters. We don't want to store those in the table, so we need a way of stripping them out.</p>
<h2 id="lexer">Lexer</h2>
<p><code>src/parser/scan.l</code></p>
<pre><code class="language-diff"> SELECT    { return SELECT; }

+  /* numbers */
+-?[0-9]+    { yylval-&gt;intval = atoi(yytext); return INTNUM; }
+
+  /* strings */
+'(\\.|[^'\n])*'  { yylval-&gt;str = strdup(yytext); return STRING; }
+
   /* everything else */
 [ \t\n]   /* whitespace */
</code></pre>
<p>We need to write some additional regex patterns to match integers and quoted strings. If you understand regex, these should make sense to you. This string pattern might be a little confusing, but essentially it will match anything surrounded by single quotes except for line terminators and a single quote character itself. We'll worry about allowing escaped single quotes later.</p>
<p>We're also adding two new tokens: <code>INTNUM</code> and <code>STRING</code> - defined in the grammar file. When we match these, we need to provide a value to send along to bison. That's where the <code>yylval-&gt;...</code> assignment statement comes from. The <code>intval</code> and <code>str</code> properties are defined in bison's <code>%union</code> section and their values will be made available to whatever code parses the associated token.</p>
<h2 id="grammar">Grammar</h2>
<p><code>src/parser/gram.y</code></p>
<pre><code class="language-diff"> %union {
   char* str;
+  int intval;

   struct Node* node;
 }

 %parse-param { struct Node** n }
 %param { void* scanner }

+%token &lt;str&gt; SYS_CMD STRING
+
+%token &lt;intval&gt; INTNUM

 /* reserved keywords in alphabetical order */
 %token INSERT
</code></pre>
<p>Here we add the <code>intval</code> property to our union, which gives flex access to it via <code>yylval-&gt;intval</code>. And we also add our new tokens. The difference between <code>%token &lt;type_name&gt; TOKEN_NAME</code> and <code>%token TOKEN_NAME</code> is just that those with an associated <code>&lt;type_name&gt;</code> will have a value attached to them.</p>
<pre><code class="language-diff">+insert_stmt: INSERT INTNUM STRING  {
-      printf(&quot;INSERT command received\n&quot;);
-      $$ = NULL;
+      InsertStmt* ins = create_node(InsertStmt);
+      ins-&gt;personId = $2;
+      ins-&gt;name = str_strip_quotes($3);
+      $$ = (Node*)ins;
     }
   ;
</code></pre>
<h2 id="running-the-program">Running the Program</h2>
<p>Since we didn't add any new files, we don't need to add anything to the Makefile. We can just compile and run:</p>
<pre><code class="language-shell">$ make &amp;&amp; ./burkeql
======   BurkeQL Config   ======
= DATA_FILE: /home/burke/source_control/burkeql-db/db_files/main.dbd
= PAGE_SIZE: 128
bql &gt; insert 5 'chris burke'
======  Node  ======
=  Type: Insert
=  person_id: 5
=  name:      chris burke
bql &gt;
</code></pre>
<p>As expected, our parser was able to identify both the Int and string we want to insert, as well as successfully strip the single quote characters from the string.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../06-page-implementation/" class="btn btn-neutral float-left" title="DB Page Implementation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../08-serializing-and-inserting-data/" class="btn btn-neutral float-right" title="Serializing and Inserting Data">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/burke1791/burkeql-db/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../06-page-implementation/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../08-serializing-and-inserting-data/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
