<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://burke1791.github.io/burkeql-db/05-selecting-data/02-the-sql-analyzer/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>The SQL Analyzer - BurkeQL Tutorial</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "The SQL Analyzer";
        var mkdocs_page_input_path = "05-selecting-data/02-the-sql-analyzer.md";
        var mkdocs_page_url = "/burkeql-db/05-selecting-data/02-the-sql-analyzer/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BurkeQL Tutorial
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../00-intro/project-plan/">Project Roadmap</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">1. Basic CLI</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/flex/">Flex</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/bison/">Bison</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">2. Abstract Syntax Trees</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-interface/">AST Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-implementation/">AST Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-interface/">Parser Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">3. The Database Page</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../03-db-page/page-structure/">Page Structure</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">4. Data Persistence</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/02-config-file/">Config File</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/03-loading-config/">Loading Config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/04-file-interface/">DB File Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/05-page-interface/">DB Page Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/06-page-implementation/">DB Page Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/07-parser-refactor-insert/">Parser Refactor - Insert</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/08-serializing-and-inserting-data/">Serializing and Inserting Data</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">5. Selecting Data</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../01-parser-refactor-select/">Parser Refactor - Select</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">The SQL Analyzer</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#running-the-program">Running the Program</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../03-buffer-pool/">Buffer Pool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../04-table-scan/">Table Scan</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../05-displaying-results/">Displaying Results</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">6. Data Types: Ints</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/01-hard-coded-table-refactor/">Hard-Coded Table Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">7. Data Types: Bool</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/01-hard-coded-table-refactor/">Hard-Coded Table Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../07-data-types-bool/04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">8. Data Types: Varchar</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/02-storage-and-fill/">Storage and Fill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/03-temporary-code-refactor/">Temporary Code Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/04-inserting-data/">Inserting Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/05-defill-and-display/">Defill and Display</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">9. Data Constraint: NULL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/03-writing-data/">Writing Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/04-reading-data/">Reading Data</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BurkeQL Tutorial</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">5. Selecting Data</li>
      <li class="breadcrumb-item active">The SQL Analyzer</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/burke1791/burkeql-db/edit/master/docs/05-selecting-data/02-the-sql-analyzer.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="the-sql-analyzer">The SQL Analyzer</h1>
<p>I want to take some time to introduce the SQL analyzer before moving forward with code changes in this section.</p>
<p>In modern DBMS's, every query you send to it passes through a handful of stages before you get your results back. You can often generalize them in five stages:</p>
<ol>
<li>Lexer/parser</li>
<li>Analyzer</li>
<li>Rewriter</li>
<li>Planner</li>
<li>Executor</li>
</ol>
<p>Right now, we are firmly planted in the lexer/parser (commonly called the parser) stage. This is what we're slowly building up with our flex and bison code. Its sole responsibility is to validate the syntax of the SQL query you give to it. The parser doesn't care if you reference tables/columns/etc that don't actually exist, it just cares that you follow the grammar rules of the query language.</p>
<p>As the parser is validating syntax, it is building a parse tree - a type of abstract syntax tree (AST). This is what we're doing with our variety of <code>Node</code> data types. When the parser is done, it sends the parse tree to the analyzer where we perform <strong>semantic</strong> analysis. All it means is we check to make sure any tables or columns referenced in the query actually exist in the database, and ensure all comparisons or operations on certain data types are allowed - things like that.</p>
<p>At this point, we can't write a true analyzer because in order to do its job, it relies on a database's system tables. These are internal tables to the database engine that store metadata about tables, columns, etc. that have been created by the user. Since we haven't implemented system tables yet, we'll need to hard-code a dumb analyzer. Fortunately it'll be pretty simple.</p>
<p><code>src/main.c</code></p>
<pre><code class="language-diff">+#include &lt;strings.h&gt;

*** other code removed for brevity ***

+static bool analyze_selectstmt(SelectStmt* s) {
+  for (int i = 0; i &lt; s-&gt;targetList-&gt;length; i++) {
+    ResTarget* r = (ResTarget*)s-&gt;targetList-&gt;elements[i].ptr;
+    if (!(strcasecmp(r-&gt;name, &quot;person_id&quot;) == 0 || strcasecmp(r-&gt;name, &quot;name&quot;) == 0)) return false;
+  }
+  return true;
+}
+
+static bool analyze_node(Node* n) {
+  switch (n-&gt;type) {
+    case T_SelectStmt:
+      return analyze_selectstmt((SelectStmt*)n);
+    default:
+      printf(&quot;analyze_node() | unhandled node type&quot;);
+  }
+
+  return false;
+}
</code></pre>
<p>We just add a couple functions to our temporary code section in <code>main.c</code>. We have a general <code>analyze_node</code> function that will call the <code>analyze_select</code> function, which returns true or false depending on the results of our "semantic analysis." All we're doing is checking if the column name in each <code>ResTarget</code> is either <code>person_id</code> or <code>name</code>. We use <code>strcasecmp</code>, which does a case-insensitive string comparison.</p>
<p><code>src/main.c</code></p>
<pre><code class="language-diff">    switch (n-&gt;type) {
      case T_SysCmd:
        if (strcmp(((SysCmd*)n)-&gt;cmd, &quot;quit&quot;) == 0) {
          free_node(n);
          printf(&quot;Shutting down...\n&quot;);
          flush_page(fdesc-&gt;fd, pg);
          free_page(pg);
          file_close(fdesc);
          return EXIT_SUCCESS;
        }
        break;
      case T_InsertStmt:
        int32_t person_id = ((InsertStmt*)n)-&gt;personId;
        char* name = ((InsertStmt*)n)-&gt;name;
        if (!insert_record(pg, person_id, name)) {
          printf(&quot;Unable to insert record\n&quot;);
        }
+       break;
+     case T_SelectStmt:
+       if (!analyze_node(n)) {
+         printf(&quot;Semantic analysis failed\n&quot;);
+       }
+       break;
    }
</code></pre>
<p>And in our <code>main</code> function we need to make a call to the analyzer. If analysis fails, we simply print a very vague and unhelpful error message - hey that's exactly what all the other SQL parsers/analyzers do too!</p>
<h2 id="running-the-program">Running the Program</h2>
<pre><code class="language-shell">$ make &amp;&amp; ./burkeql
======   BurkeQL Config   ======
= DATA_FILE: /home/burke/source_control/burkeql-db/db_files/main.dbd
= PAGE_SIZE: 128
bql &gt; select person_id, name;
======  Node  ======
=  Type: Select
=  Targets:
=    person_id
=    name
bql &gt; select foo, bar, baz;
======  Node  ======
=  Type: Select
=  Targets:
=    foo
=    bar
=    baz
Semantic analysis failed
bql &gt;
</code></pre>
<p>Here I tried two select statements. The first one is valid, selecting both of the column names in our hard-coded table. The second gets rejected because none of my columns exist in the table.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../01-parser-refactor-select/" class="btn btn-neutral float-left" title="Parser Refactor - Select"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../03-buffer-pool/" class="btn btn-neutral float-right" title="Buffer Pool">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/burke1791/burkeql-db/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../01-parser-refactor-select/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../03-buffer-pool/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
