<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://burke1791.github.io/burkeql-db/07-data-types-bool/01-hard-coded-table-refactor/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Hard-Coded Table Refactor - BurkeQL Tutorial</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Hard-Coded Table Refactor";
        var mkdocs_page_input_path = "07-data-types-bool/01-hard-coded-table-refactor.md";
        var mkdocs_page_url = "/burkeql-db/07-data-types-bool/01-hard-coded-table-refactor/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BurkeQL Tutorial
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../00-intro/project-plan/">Project Roadmap</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">1. Basic CLI</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/flex/">Flex</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/bison/">Bison</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../01-basic-cli/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">2. Abstract Syntax Trees</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-interface/">AST Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/ast-implementation/">AST Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/parser-interface/">Parser Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../02-ast/putting-it-together/">Putting It Together</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">3. The Database Page</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../03-db-page/page-structure/">Page Structure</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">4. Data Persistence</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/02-config-file/">Config File</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/03-loading-config/">Loading Config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/04-file-interface/">DB File Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/05-page-interface/">DB Page Interface</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/06-page-implementation/">DB Page Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/07-parser-refactor-insert/">Parser Refactor - Insert</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../04-data-persistence/08-serializing-and-inserting-data/">Serializing and Inserting Data</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">5. Selecting Data</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/01-parser-refactor-select/">Parser Refactor - Select</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/02-the-sql-analyzer/">The SQL Analyzer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/03-buffer-pool/">Buffer Pool</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/04-table-scan/">Table Scan</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../05-selecting-data/05-displaying-results/">Displaying Results</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">6. Data Types: Ints</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/01-hard-coded-table-refactor/">Hard-Coded Table Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../06-data-types-ints/04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">7. Data Types: Bool</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Hard-Coded Table Refactor</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#table-ddl">Table DDL</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#refactoring">Refactoring</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../03-fill-and-defill/">Fill and Defill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../04-select-updates/">Select Updates</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">8. Data Types: Varchar</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/02-storage-and-fill/">Storage and Fill</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/03-temporary-code-refactor/">Temporary Code Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/04-inserting-data/">Inserting Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../08-data-types-varchar/05-defill-and-display/">Defill and Display</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">9. Data Constraint: NULL</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/01-intro/">Intro</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/02-parser-refactor/">Parser Refactor</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/03-writing-data/">Writing Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../09-data-constraint-null/04-reading-data/">Reading Data</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BurkeQL Tutorial</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">7. Data Types: Bool</li>
      <li class="breadcrumb-item active">Hard-Coded Table Refactor</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/burke1791/burkeql-db/edit/master/docs/07-data-types-bool/01-hard-coded-table-refactor.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="hard-coded-table-refactor">Hard-Coded Table Refactor</h1>
<p>I don't know about you, but I'm starting to get real tired of refactoring our temporary code due to introducing a new data type. Rest assured, relief is on the horizon, but we're not there just yet.</p>
<p>Quick note: most of the text in this section will mostly be copy/pasted (with applicable changes) from the last section where we introduced the <code>Int</code>'s. That's because we're changing the code in all the same places, so you can skip to the code diff sections if you don't feel like reading the same walls of text again.</p>
<p>In this section, we're introducing the <code>Bool</code> data type. Its storage footprint will fill one byte and we'll be using the <code>uint8_t</code> C type in our code. The <code>Bool</code> is essentially a <code>TinyInt</code>, but will only have two valid values: true and false. Using a full byte to store something that only needs a single bit may seem inefficient... and it absolutely is. However, there's all sorts of extra logical overhead that comes with packing multiple <code>Bools</code> in a single byte that I don't want to deal with.</p>
<p>Some database engines, like Microsoft SQL Server, do indeed store boolean values in a single bit. In MSSQL's case, the data type is actually called a <code>Bit</code>. It still requires a full byte of storage space, but if a table contains more than one <code>Bit</code> column, the engine is able to stuff up to 8 of them in that single byte.</p>
<p>I want to keep our code simple, so we're going to use a full byte for each <code>Bool</code> column we come across.</p>
<h2 id="table-ddl">Table DDL</h2>
<p>First thing's first, our new table definition. It's the same as last time, except we're adding a <code>Bool</code> column to the end:</p>
<pre><code class="language-sql">Create Table person (
    person_id Int Not Null,
    name Char(20) Not Null,
    age TinyInt Not Null,
    daily_steps SmallInt Not Null,
    distance_from_home BigInt Not Null,
    is_alive Bool Not Null
);
</code></pre>
<p>And for fun let's calculate the byte requirement of a new record:</p>
<ul>
<li>12-byte header</li>
<li>4-byte <code>person_id</code></li>
<li>20-byte <code>name</code></li>
<li>1-byte <code>age</code></li>
<li>2-byte <code>daily_steps</code></li>
<li>8-byte <code>distance_from_home</code></li>
<li>1-byte <code>is_alive</code></li>
<li>4-byte slot pointer</li>
<li><strong>total</strong>: 52 bytes</li>
</ul>
<p>Since the page header consumes the first 20 bytes, we can just barely fit two records on our 128-byte data page.</p>
<h2 id="refactoring">Refactoring</h2>
<p>Let's start adding support for the new data type. Beginning witht he obvious: the <code>DataType</code> enum.</p>
<p><code>src/include/storage/record.h</code></p>
<pre><code class="language-diff"> typedef enum DataType {
   DT_TINYINT,     /* 1-byte, unsigned */
   DT_SMALLINT,    /* 2-bytes, signed */
   DT_INT,         /* 4-bytes, signed */
   DT_BIGINT,      /* 8-bytes, signed */
+  DT_BOOL,        /* 1-byte, unsigned | similar to DT_TINYINT, but always evaluates to 1 or 0 */
   DT_CHAR,        /* Byte-size defined at table creation */
   DT_UNKNOWN
 } DataType;
</code></pre>
<p>Next, we can update all of our temporary functions in our <code>main.c</code> file:</p>
<p><code>src/main.c</code></p>
<pre><code class="language-diff">-#define RECORD_LEN  47
+#define RECORD_LEN  48

-static void populate_datum_array(Datum* data, int32_t person_id, char* name, uint8_t age, int16_t dailySteps, int64_t  distanceFromHome) { 
+static void populate_datum_array(Datum* data, int32_t person_id, char* name, uint8_t age, int16_t dailySteps, int64_t  distanceFromHome, uint8_t isAlive) {
   data[0] = int32GetDatum(person_id);
   data[1] = charGetDatum(name);
   data[2] = uint8GetDatum(age);
   data[3] = int16GetDatum(dailySteps);
   data[4] = int64GetDatum(distanceFromHome);
+  data[5] = uint8GetDatum(isAlive);
 }
</code></pre>
<p>We need to update the <code>RECORD_LEN</code> macro to reflect the total footprint of our data records. Note it's 48 instead of 52 (from above) because this macro does not include the 4-byte slot pointer. We also piggyback on the existing <code>uint8</code> datum conversion function because that's how we're representing the <code>Bool</code> data type.</p>
<p>Next, we add parameters for each of the new columns in our table as well as calls to the datum conversion functions that we will need to write.</p>
<pre><code class="language-diff"> static RecordDescriptor* construct_record_descriptor() {
-  RecordDescriptor* rd = malloc(sizeof(RecordDescriptor) + (5 * sizeof(Column)));
+  RecordDescriptor* rd = malloc(sizeof(RecordDescriptor) + (6 * sizeof(Column)));
-  rd-&gt;ncols = 5;
+  rd-&gt;ncols = 6;

   construct_column_desc(&amp;rd-&gt;cols[0], &quot;person_id&quot;, DT_INT, 0, 4);
   construct_column_desc(&amp;rd-&gt;cols[1], &quot;name&quot;, DT_CHAR, 1, 20);
   construct_column_desc(&amp;rd-&gt;cols[2], &quot;age&quot;, DT_TINYINT, 2, 1);
   construct_column_desc(&amp;rd-&gt;cols[3], &quot;daily_steps&quot;, DT_SMALLINT, 3, 2);
   construct_column_desc(&amp;rd-&gt;cols[4], &quot;distance_from_home&quot;, DT_BIGINT, 4, 8);
+  construct_column_desc(&amp;rd-&gt;cols[5], &quot;is_alive&quot;, DT_BOOL, 5, 1);

   return rd;
 }
</code></pre>
<p>We update our <code>RecordDescriptor</code> factory to create a <code>RecordDescriptor</code> with 6 columns now instead of 5, and add calls to <code>construct_column_desc</code> with the appropriate inputs for our new <code>DT_BOOL</code> column.</p>
<pre><code class="language-diff">-static void serialize_data(RecordDescriptor* rd, Record r, int32_t person_id, char* name, uint8_t age, int16_t  dailySteps, int64_t distanceFromHome) {
+static void serialize_data(RecordDescriptor* rd, Record r, int32_t person_id, char* name, uint8_t age, int16_t  dailySteps, int64_t distanceFromHome, uint8_t isAlive) {
   Datum* data = malloc(rd-&gt;ncols * sizeof(Datum));
-  populate_datum_array(data, person_id, name, age, dailySteps, distanceFromHome);
+  populate_datum_array(data, person_id, name, age, dailySteps, distanceFromHome, isAlive);
   fill_record(rd, r + sizeof(RecordHeader), data);
   free(data);
 }
</code></pre>
<p>Our serializer function just needs to include the new column as a parameter, and pass it to the <code>populate_datum_array</code> function.</p>
<pre><code class="language-diff">-static bool insert_record(BufPool* bp, int32_t person_id, char* name, uint8_t age, int16_t dailySteps, int64_t  distanceFromHome) {
+static bool insert_record(BufPool* bp, int32_t person_id, char* name, uint8_t age, int16_t dailySteps, int64_t  distanceFromHome, uint8_t isAlive) {
   BufPoolSlot* slot = bufpool_read_page(bp, 1);
   if (slot == NULL) slot = bufpool_new_page(bp);
   RecordDescriptor* rd = construct_record_descriptor();
   Record r = record_init(RECORD_LEN);
-  serialize_data(rd, r, person_id, name, age, dailySteps, distanceFromHome);
+  serialize_data(rd, r, person_id, name, age, dailySteps, distanceFromHome, isAlive);
   bool insertSuccessful = page_insert(slot-&gt;pg, r, RECORD_LEN);

   free_record_desc(rd);
   free(r);

   return insertSuccessful;
 }
</code></pre>
<p>Similar to the above, we just add the new parameter and pass it along.</p>
<pre><code class="language-diff"> static bool analyze_selectstmt(SelectStmt* s) {
   for (int i = 0; i &lt; s-&gt;targetList-&gt;length; i++) {
     ResTarget* r = (ResTarget*)s-&gt;targetList-&gt;elements[i].ptr;
     if (
       !(
         strcasecmp(r-&gt;name, &quot;person_id&quot;) == 0 ||
         strcasecmp(r-&gt;name, &quot;name&quot;) == 0 ||
         strcasecmp(r-&gt;name, &quot;age&quot;) == 0 ||
         strcasecmp(r-&gt;name, &quot;daily_steps&quot;) == 0 ||
-        strcasecmp(r-&gt;name, &quot;distance_from_home&quot;) == 0
+        strcasecmp(r-&gt;name, &quot;distance_from_home&quot;) == 0 ||
+        strcasecmp(r-&gt;name, &quot;is_alive&quot;) == 0
       )
     ) {
       return false;
     }
   }
   return true;
 }
</code></pre>
<p>And the last of our temporary functions, the analyzer, just needs to check for the new column in the <code>Select</code> target list.</p>
<p>That's it for refactoring the temporary code. Next up, we'll refactor the parser to make sure it looks for the new column in its insert statement grammar.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../06-data-types-ints/04-select-updates/" class="btn btn-neutral float-left" title="Select Updates"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../02-parser-refactor/" class="btn btn-neutral float-right" title="Parser Refactor">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/burke1791/burkeql-db/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../06-data-types-ints/04-select-updates/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../02-parser-refactor/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
